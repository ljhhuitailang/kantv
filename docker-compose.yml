# Docker Compose 配置文件
# 用于快速部署 KanTV
#
# 使用方法：
# 1. 复制 .env.example 到 .env 并配置环境变量
# 2. 运行: docker-compose up -d

version: '3.8'

services:
  # KanTV 应用 - 使用 Kvrocks 数据库
  kantv:
    build: .
    container_name: kantv
    ports:
      - "3000:3000"
    environment:
      # 存储类型
      NEXT_PUBLIC_STORAGE_TYPE: kvrocks

      # 管理员账号（必填）
      USERNAME: ${USERNAME:-admin}
      PASSWORD: ${PASSWORD:-changeme}

      # Kvrocks 连接
      KVROCKS_URL: redis://kvrocks:6666

      # 站点配置
      NEXT_PUBLIC_SITE_NAME: ${NEXT_PUBLIC_SITE_NAME:-KanTV}
      SITE_BASE: ${SITE_BASE:-}
      ANNOUNCEMENT: ${ANNOUNCEMENT:-}

      # 用户注册
      NEXT_PUBLIC_ENABLE_REGISTRATION: ${NEXT_PUBLIC_ENABLE_REGISTRATION:-false}

      # 搜索配置
      NEXT_PUBLIC_SEARCH_MAX_PAGE: ${NEXT_PUBLIC_SEARCH_MAX_PAGE:-5}
      NEXT_PUBLIC_FLUID_SEARCH: ${NEXT_PUBLIC_FLUID_SEARCH:-true}

      # 成人内容过滤（全局设置）
      NEXT_PUBLIC_DISABLE_YELLOW_FILTER: ${NEXT_PUBLIC_DISABLE_YELLOW_FILTER:-false}

      # 豆瓣代理配置
      NEXT_PUBLIC_DOUBAN_PROXY_TYPE: ${NEXT_PUBLIC_DOUBAN_PROXY_TYPE:-}
      NEXT_PUBLIC_DOUBAN_PROXY: ${NEXT_PUBLIC_DOUBAN_PROXY:-}
      NEXT_PUBLIC_DOUBAN_IMAGE_PROXY_TYPE: ${NEXT_PUBLIC_DOUBAN_IMAGE_PROXY_TYPE:-}
      NEXT_PUBLIC_DOUBAN_IMAGE_PROXY: ${NEXT_PUBLIC_DOUBAN_IMAGE_PROXY:-}
    depends_on:
      - kvrocks
    restart: unless-stopped
    networks:
      - kantv-network

  # Kvrocks 数据库（推荐）
  kvrocks:
    image: apache/kvrocks:latest
    container_name: kantv-kvrocks
    ports:
      - "6666:6666"
    volumes:
      - kvrocks-data:/var/lib/kvrocks
    restart: unless-stopped
    networks:
      - kantv-network

  # 可选：Redis 数据库（如果你想使用 Redis 而不是 Kvrocks）
  # 取消下面的注释并修改 kantv 服务中的 NEXT_PUBLIC_STORAGE_TYPE 和连接 URL
  # redis:
  #   image: redis:7-alpine
  #   container_name: kantv-redis
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis-data:/data
  #   command: redis-server --appendonly yes
  #   restart: unless-stopped
  #   networks:
  #     - kantv-network

volumes:
  kvrocks-data:
    driver: local
  # redis-data:
  #   driver: local

networks:
  kantv-network:
    driver: bridge

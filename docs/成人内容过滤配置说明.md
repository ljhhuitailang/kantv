# KanTV 成人内容过滤配置说明

## 问题分析

### 为什么环境变量 NEXT_PUBLIC_DISABLE_YELLOW_FILTER 不生效？

**根本原因**：`NEXT_PUBLIC_DISABLE_YELLOW_FILTER` 是 **Next.js 构建时环境变量**

在 Next.js 中，所有 `NEXT_PUBLIC_` 前缀的环境变量都会在**构建阶段**被内联到代码中。这意味着：

- ❌ **运行时修改无效**：使用预构建的 Docker 镜像时，修改环境变量不会生效
- ✅ **构建时才有效**：只有在构建镜像时设置的值才会生效
- ⚠️ **已修复**：v1.2.0+ 版本支持通过管理后台动态修改，无需重启

### 已修复的 Bug

**v1.2.0 之前**：
- 管理后台修改全局设置后，配置被保存到数据库
- 但内存缓存未刷新，其他 API 仍使用旧配置
- 导致管理后台的设置看似保存成功，实际不生效

**v1.2.0 修复**：
- 保存配置后立即刷新内存缓存
- 所有 API 请求立即使用新配置
- 无需重启应用

---

## ✅ 正确配置方法

### 方式一：通过管理后台配置（推荐）

**步骤**：

1. **登录管理后台**
   ```
   访问：http://your-domain.com/admin
   使用站长账号登录
   ```

2. **进入站点设置**
   - 点击左侧导航的"站点设置"或"Site Settings"
   - 找到"启用成人内容过滤"开关

3. **修改全局设置**
   - 🟢 **开启开关**（绿色）= 全局启用过滤（默认隐藏成人内容）
   - 🔴 **关闭开关**（红色）= 全局禁用过滤（默认显示成人内容）

4. **立即生效**
   - 修改后立即生效，无需重启
   - 所有用户都会使用新的全局设置

### 方式二：用户级别控制（精细化管理）

站长可以为每个用户单独配置过滤设置，**优先级高于全局设置**。

**步骤**：

1. 登录管理后台 → 用户管理
2. 找到目标用户，点击"成人内容过滤"列的开关
   - 🟢 **绿色**（可查看）= 该用户禁用过滤（可查看成人内容）
   - 🔴 **红色**（已过滤）= 该用户启用过滤（禁止查看成人内容）

**应用场景**：

- **家庭模式**：全局禁用过滤，但为儿童账号单独启用过滤
- **企业模式**：全局启用过滤，但为特定用户（如内容审核员）禁用过滤

---

## 🎯 优先级规则

KanTV 使用三级优先级系统，优先级从高到低：

### 1. URL 参数（最高优先级）⚡

**用途**：临时覆盖设置，适用于不同场景

**OrionTV / TVBox 参数**：
```
?adult=1 或 ?adult=true    # 不过滤（显示成人内容）
?adult=0 或 ?adult=false   # 过滤（隐藏成人内容）
```

**通用参数**：
```
?filter=off 或 ?filter=disable  # 不过滤
?filter=on  或 ?filter=enable   # 过滤
```

**路径前缀**（OrionTV 专用）：
```
https://your-domain.com/adult/  # 自动添加 ?adult=1
```

### 2. 用户级别设置（中优先级）👤

- 站长在管理后台为特定用户配置
- 仅当 URL 参数未指定时生效
- **示例**：
  - 全局设置：禁用过滤（默认显示成人内容）
  - 用户 A 设置：启用过滤
  - **结果**：用户 A 看不到成人内容（用户设置优先）

### 3. 全局设置（最低优先级）🌐

- 站长在管理后台的"站点设置"中配置
- 作为所有用户的默认设置
- 当用户级别设置为空时使用此值

---

## 📋 配置示例

### 示例 1：家庭安全模式（默认过滤）

**场景**：家庭使用，默认隐藏成人内容

**配置**：
```
1. 全局设置：启用过滤（绿色开关）
2. 成人用户：单独关闭过滤（红色→绿色）
3. 儿童用户：保持默认（使用全局设置）
```

**结果**：
- 成人用户可以查看成人内容
- 儿童用户看不到成人内容

### 示例 2：成人模式（默认不过滤）

**场景**：成人站点，默认显示所有内容

**配置**：
```
1. 全局设置：禁用过滤（红色开关）
2. 所有用户：不需要单独配置
```

**结果**：
- 所有用户都可以查看成人内容

### 示例 3：企业模式（严格过滤）

**场景**：企业内网，严格过滤，只有审核员可查看

**配置**：
```
1. 全局设置：启用过滤（绿色开关）
2. 普通员工：保持默认
3. 内容审核员：单独关闭过滤
```

**结果**：
- 普通员工看不到成人内容
- 审核员可以查看成人内容

---

## 🔧 故障排查

### 问题 1：修改环境变量后不生效

**症状**：
```bash
# Docker 部署时设置
NEXT_PUBLIC_DISABLE_YELLOW_FILTER=true

# 但成人内容仍被过滤
```

**原因**：这是构建时变量，运行时修改无效

**解决**：
1. **推荐**：通过管理后台修改（立即生效）
2. 或重新构建 Docker 镜像：
   ```bash
   docker build --build-arg NEXT_PUBLIC_DISABLE_YELLOW_FILTER=true -t kantv .
   ```

### 问题 2：管理后台修改后不生效

**症状**：在管理后台修改了设置，但搜索结果没有变化

**可能原因**：
1. **版本太旧**：v1.2.0 之前的版本有缓存 bug
2. **浏览器缓存**：浏览器缓存了旧的搜索结果

**解决**：
1. **升级到 v1.2.0+**：
   ```bash
   docker pull ghcr.io/ljhhuitailang/kantv:v1.2.0
   ```
2. 清除浏览器缓存或强制刷新（Ctrl+F5）
3. 如果仍不生效，重启 Docker 容器：
   ```bash
   docker-compose restart
   ```

### 问题 3：部分用户可以看到，部分用户看不到

**症状**：同一个影片，有的用户能搜到，有的搜不到

**可能原因**：用户级别设置不同

**检查**：
1. 登录管理后台 → 用户管理
2. 查看"成人内容过滤"列
3. 确认不同用户的设置

**解决**：
- 统一设置：批量修改用户设置
- 或使用 URL 参数临时覆盖：`?adult=1`

---

## 🚀 最佳实践

### 推荐配置流程

1. **初次部署**：
   - 不设置环境变量（使用默认值）
   - 启动后通过管理后台配置

2. **全局策略**：
   - 进入管理后台 → 站点设置
   - 设置全局过滤策略（默认行为）

3. **用户级别**：
   - 进入用户管理
   - 为特殊用户单独配置

4. **测试验证**：
   - 使用不同用户登录测试
   - 使用 URL 参数测试优先级

### 安全建议

- ✅ 家庭环境：全局启用过滤，为成人用户单独配置
- ✅ 公共服务：默认启用过滤，提供 URL 参数供成人用户使用
- ✅ 企业内网：严格启用过滤，禁用 URL 参数覆盖

---

## 📞 获取帮助

如果遇到问题：

1. 📖 查看本文档的故障排查部分
2. 🐛 提交 Issue：[GitHub Issues](https://github.com/ljhhuitailang/kantv/issues)
3. 📚 查看其他文档：
   - [成人内容过滤使用指南](./成人内容过滤使用指南.md)
   - [OrionTV 使用指南](./OrionTV使用指南.md)

---

**最后更新**：2026-01-08
**适用版本**：v1.2.0+
